# 🔄 再平衡机制详解

## 📚 什么是再平衡？

**再平衡（Rebalance）** = 将资产配置调整回目标权重

### 举个例子

**初始配置**（100万）:
- 纳指：25万（25%）
- 标普：25万（25%）
- 红利：25万（25%）
- 现金流：25万（25%）

**一段时间后**（假设纳指大涨，总市值150万）:
- 纳指：60万（**40%**）← 偏离目标
- 标普：30万（20%）
- 红利：30万（20%）
- 现金流：30万（20%）

**再平衡操作**:
- 卖出纳指：60万 → 37.5万（回到25%）
- 买入标普：30万 → 37.5万
- 买入红利：30万 → 37.5万
- 买入现金流：30万 → 37.5万

---

## 💻 核心代码详解

### 1. 检查是否需要再平衡

```python
def check_rebalance_needed(self, date_idx, shares_dict, prices_dict):
    """
    检查是否需要再平衡
    """
    # 第一步：计算当前各资产的市值
    total_value = 0
    asset_values = {}
    
    for key in self.portfolio_config.keys():
        # 市值 = 持仓份额 × 当前价格
        value = shares_dict[key][date_idx] * prices_dict[key][date_idx]
        asset_values[key] = value
        total_value += value
    
    # 第二步：检查每个资产的实际占比
    triggers = []
    for key, config in self.portfolio_config.items():
        # 计算实际权重
        current_weight = asset_values[key] / total_value
        target_weight = config['weight']  # 目标权重
        
        # 计算阈值（相对阈值20%）
        abs_threshold = target_weight * 0.20
        
        # 计算偏离度
        deviation = abs(current_weight - target_weight)
        
        # 判断是否超出阈值
        if deviation > abs_threshold:
            triggers.append({
                'asset': config['name'],
                'current': current_weight * 100,
                'target': target_weight * 100,
                'deviation': deviation * 100
            })
    
    # 如果有任何资产超出阈值，触发再平衡
    return len(triggers) > 0, triggers
```

### 2. 执行再平衡

```python
def rebalance_portfolio(self, date_idx, shares_dict, prices_dict):
    """
    执行再平衡 - 核心逻辑
    """
    # 第一步：计算当前总市值
    total_value = 0
    for key in self.portfolio_config.keys():
        total_value += shares_dict[key][date_idx] * prices_dict[key][date_idx]
    
    # 第二步：按目标权重重新分配
    new_shares = {}
    for key, config in self.portfolio_config.items():
        # 计算该资产的目标市值
        target_value = total_value * config['weight']
        
        # 计算需要持有的份额
        new_shares[key] = target_value / prices_dict[key][date_idx]
    
    return new_shares, total_value
```

---

## 🔢 具体计算示例

### 场景：2020年6月10日触发再平衡

#### 再平衡前

**总市值**: ¥1,474,634.89

| 资产 | 持仓份额 | 当前价格 | 市值 | 实际占比 | 目标占比 | 偏离 |
|------|---------|---------|------|---------|---------|------|
| 纳指 | 32.20 | 12,395.13 | ¥399,223 | **27.1%** | 22.5% | **+4.6%** ⚠️ |
| 标普 | 107.37 | 3,193.93 | ¥342,960 | 23.3% | 22.5% | +0.8% |
| 红利 | 36.61 | 8,893.99 | ¥325,647 | 22.1% | 22.5% | -0.4% |
| 现金流 | 181.67 | 2,044.64 | ¥371,454 | 25.2% | 22.5% | +2.7% |
| 证金债 | 1,071.05 | 142.00 | ¥35,350 | 7.9% | 10.0% | -2.1% |

**触发原因**: 纳指占比27.1%，偏离目标22.5%超过4.6%，超出阈值4.5%

#### 再平衡操作

```python
# 计算目标市值
总市值 = 1,474,634.89

纳指目标市值 = 1,474,634.89 × 22.5% = 331,792.85
标普目标市值 = 1,474,634.89 × 22.5% = 331,792.85
红利目标市值 = 1,474,634.89 × 22.5% = 331,792.85
现金流目标市值 = 1,474,634.89 × 22.5% = 331,792.85
证金债目标市值 = 1,474,634.89 × 10.0% = 147,463.49

# 计算新的持仓份额
纳指新份额 = 331,792.85 / 12,395.13 = 26.77份（原32.20份）
标普新份额 = 331,792.85 / 3,193.93 = 103.89份（原107.37份）
红利新份额 = 331,792.85 / 8,893.99 = 37.31份（原36.61份）
现金流新份额 = 331,792.85 / 2,044.64 = 162.26份（原181.67份）
证金债新份额 = 147,463.49 / 142.00 = 1,038.47份（原1,071.05份）
```

#### 再平衡后

| 资产 | 原持仓 | 新持仓 | 变化 | 操作 | 新占比 |
|------|--------|--------|------|------|--------|
| 纳指 | 32.20 | 26.77 | **-5.43** | 卖出 | 22.5% ✅ |
| 标普 | 107.37 | 103.89 | -3.48 | 卖出 | 22.5% ✅ |
| 红利 | 36.61 | 37.31 | +0.70 | 买入 | 22.5% ✅ |
| 现金流 | 181.67 | 162.26 | **-19.41** | 卖出 | 22.5% ✅ |
| 证金债 | 1,071.05 | 1,038.47 | -32.58 | 卖出 | 10.0% ✅ |

**结果**: 所有资产回到目标权重！

---

## 🔍 阈值判断逻辑

### 相对阈值（20%）的计算

```python
# 对于22.5%的资产
target_weight = 0.225
relative_threshold = 0.20
abs_threshold = 0.225 × 0.20 = 0.045 (即4.5%)

# 触发范围
lower_bound = 0.225 - 0.045 = 0.180 (18.0%)
upper_bound = 0.225 + 0.045 = 0.270 (27.0%)

# 判断逻辑
if 实际占比 < 18.0% or 实际占比 > 27.0%:
    触发再平衡
```

```python
# 对于10%的资产（证金债）
target_weight = 0.10
abs_threshold = 0.10 × 0.20 = 0.02 (即2%)

# 触发范围
lower_bound = 0.10 - 0.02 = 0.08 (8.0%)
upper_bound = 0.10 + 0.02 = 0.12 (12.0%)

# 判断逻辑
if 实际占比 < 8.0% or 实际占比 > 12.0%:
    触发再平衡
```

---

## 📊 完整再平衡流程图

```
每个交易日
    │
    ├─ 是否在定投期？
    │   ├─ 是 → 继续定投（不检查再平衡）
    │   └─ 否 → 检查是否需要再平衡
    │       │
    │       ├─ 计算当前各资产市值和占比
    │       │
    │       ├─ 对每个资产检查：
    │       │   当前占比 vs 目标占比
    │       │   │
    │       │   ├─ 偏离 > 阈值？
    │       │   │   ├─ 是 → 标记需要再平衡
    │       │   │   └─ 否 → 继续持有
    │       │
    │       └─ 有资产触发阈值？
    │           ├─ 是 → 执行再平衡
    │           │   │
    │           │   ├─ 计算总市值
    │           │   ├─ 按目标权重分配
    │           │   └─ 计算新的持仓份额
    │           │
    │           └─ 否 → 持仓不变
```

---

## 💡 关键代码位置

### 阈值触发再平衡策略

**文件**: `backtest_with_bond_threshold.py`

**核心函数**:

1. **`check_rebalance_needed()`** (第119-164行)
   - 检查是否需要再平衡
   - 计算各资产当前占比
   - 判断是否超出阈值

2. **`rebalance_portfolio()`** (第166-189行)
   - 执行再平衡操作
   - 按目标权重重新分配资产
   - 计算新的持仓份额

3. **`run_backtest()`** (第191-298行)
   - 主回测循环
   - 在第226-246行调用再平衡检查
   - 在第233-241行执行再平衡

---

## 🎯 再平衡示例：完整过程

### 示例：2024年1月22日

#### 步骤1: 检查触发条件

```python
# 当天各资产市值
纳指市值 = 30.54份 × 17,133.22 = ¥523,290
总市值 = ¥2,452,003

# 计算占比
纳指占比 = 523,290 / 2,452,003 = 21.3%

# 等等... 假设纳指实际是27.3%

# 检查阈值
目标 = 22.5%
阈值 = 22.5% × 20% = 4.5%
偏离 = |27.3% - 22.5%| = 4.8%

# 判断
4.8% > 4.5% → 触发再平衡！
```

#### 步骤2: 计算新持仓

```python
# 计算各资产目标市值
总市值 = ¥2,452,003

纳指目标 = 2,452,003 × 22.5% = ¥551,700
标普目标 = 2,452,003 × 22.5% = ¥551,700
红利目标 = 2,452,003 × 22.5% = ¥551,700
现金流目标 = 2,452,003 × 22.5% = ¥551,700
证金债目标 = 2,452,003 × 10.0% = ¥245,200

# 计算新份额（目标市值 / 当前价格）
纳指新份额 = 551,700 / 17,133.22 = 32.20份
标普新份额 = 551,700 / 6,890.59 = 80.06份
...以此类推
```

#### 步骤3: 执行调整

```python
# 更新持仓
shares_dict['nasdaq100'][today] = 32.20  # 从原来的份额调整
shares_dict['sp500'][today] = 80.06
shares_dict['csi930955'][today] = ...
shares_dict['csi980092'][today] = ...
shares_dict['cnb00003'][today] = ...

# 所有资产现在都回到目标权重！
```

---

## 📋 两种阈值策略对比

### 固定阈值（5%）

```python
# backtest_threshold_rebalance.py

# 所有资产使用相同阈值
threshold = 5%

# 触发条件
if 任何资产占比 < 20% or > 30%:
    触发再平衡
```

**特点**:
- 简单直接
- 所有资产一视同仁
- 可能对小权重资产不够敏感

### 相对阈值（20%）⭐

```python
# backtest_with_bond_threshold.py

# 每个资产有不同阈值
for asset in assets:
    abs_threshold = asset.target_weight × 20%
    
# 例如：
# 22.5%的资产: 阈值 = 22.5% × 20% = 4.5%
# 10%的资产: 阈值 = 10% × 20% = 2.0%
```

**特点**:
- 更加合理
- 大权重资产容忍范围大（4.5%）
- 小权重资产容忍范围小（2%）
- **推荐使用**✅

---

## 🔬 实际再平衡案例分析

### 案例1: 2017-11-07（证金债触发）

**触发原因**: 证金债从10%降到8.0%

| 资产 | 再平衡前 | 再平衡后 | 操作 |
|------|---------|---------|------|
| 纳指 | 24.5% | → 22.5% | 卖出部分 |
| 标普 | 23.8% | → 22.5% | 卖出部分 |
| 红利 | 22.9% | → 22.5% | 卖出部分 |
| 现金流 | 20.8% | → 22.5% | 买入 |
| **证金债** | **8.0%** ⚠️ | → 10.0% ✅ | **买入** |

**效果**: 从强势资产（纳指等）调仓到弱势资产（证金债、现金流）

---

### 案例2: 2024-01-22（纳指触发）

**触发原因**: 纳指从22.5%涨到27.3%

| 资产 | 再平衡前 | 再平衡后 | 操作 |
|------|---------|---------|------|
| **纳指** | **27.3%** ⚠️ | → 22.5% ✅ | **卖出** |
| 标普 | 22.1% | → 22.5% | 买入 |
| 红利 | 21.9% | → 22.5% | 买入 |
| 现金流 | 21.2% | → 22.5% | 买入 |
| 证金债 | 7.5% | → 10.0% | 买入 |

**效果**: 卖出涨得多的（纳指），买入涨得少的，实现**高抛低吸**

---

## 🎓 再平衡的本质

### 为什么要再平衡？

1. **控制风险**: 避免单一资产占比过高
2. **高抛低吸**: 自动卖高买低
3. **维持策略**: 保持初始资产配置意图

### 再平衡 = 自动化的投资纪律

```
不再平衡:
  涨的多的资产 → 占比越来越高 → 集中度风险↑
  
再平衡:
  涨的多的资产 → 卖出一部分（止盈）
  涨的少的资产 → 买入一部分（补仓）
  → 保持均衡配置 → 风险可控
```

---

## 📊 代码执行流程

### 在回测主循环中

```python
for i in range(len(dates)):
    if i > 0:
        current_date = dates[i]
        
        # 1. 定投期：只定投，不检查再平衡
        if current_date <= regular_invest_end:
            for key in assets:
                继续定投...
        
        # 2. 定投结束后：检查再平衡
        else:
            # 2.1 先复制昨天的持仓
            for key in assets:
                shares[key][i] = shares[key][i-1]
            
            # 2.2 检查是否需要再平衡
            need_rebalance, reason = check_rebalance_needed(...)
            
            # 2.3 如果需要，执行再平衡
            if need_rebalance:
                print(f"触发再平衡: {current_date}")
                print(f"原因: {reason}")
                
                # 计算新持仓
                new_shares, total_value = rebalance_portfolio(...)
                
                # 更新持仓
                for key in assets:
                    shares[key][i] = new_shares[key]
```

---

## 🆚 三种策略的代码差异

### 不再平衡
```python
# 定投结束后
if current_date > regular_invest_end:
    # 持仓不变
    shares[i] = shares[i-1]
```

### 定期再平衡
```python
# 定投结束后
if current_date > regular_invest_end:
    # 检查是否到再平衡日（每半年）
    if current_date in rebalance_dates:
        执行再平衡()
    else:
        shares[i] = shares[i-1]
```

### 阈值触发再平衡 ⭐
```python
# 定投结束后
if current_date > regular_invest_end:
    # 检查是否偏离阈值
    if check_rebalance_needed():
        执行再平衡()
    else:
        shares[i] = shares[i-1]
```

---

## 💰 再平衡的经济意义

### 以2024-01-22再平衡为例

**操作**:
- 卖出纳指：从27.3%调到22.5%
- 卖出金额：约¥11.8万

**收益**:
- 纳指后续从17,133涨到26,119（涨52.5%）
- 卖掉的11.8万，如果不卖能变成18万
- **看起来亏了？**

**实际**:
- 这11.8万买入了其他资产
- 分散了风险，降低了波动
- 避免了纳指占比过高（如果不平衡会涨到40%+）
- 2022年纳指大跌时，会感谢这次卖出

### 再平衡的真正价值

不是最大化收益，而是：
1. ✅ 控制风险（避免过度集中）
2. ✅ 降低波动（提升投资体验）
3. ✅ 强制纪律（克服贪婪和恐惧）

---

## 🔧 查看完整代码

### 含债阈值再平衡策略（推荐）
```bash
# 查看完整代码
cat etf_reblance/backtest_with_bond_threshold.py

# 关键函数位置
# - check_rebalance_needed(): 第119-164行
# - rebalance_portfolio(): 第166-189行
# - run_backtest(): 第191-298行（主逻辑）
```

### 运行并查看输出
```bash
cd etf_reblance
python backtest_with_bond_threshold.py
```

输出会显示每次触发再平衡的详细信息！

---

**总结**: 再平衡就是在市场自然波动导致配置偏离时，通过买卖操作将其调整回目标配置。🎯

