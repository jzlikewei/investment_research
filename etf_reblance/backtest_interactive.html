<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF投资组合回测工具</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        /* ========== CSS Variables ========== */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --gray-100: #f8f9fa;
            --gray-200: #dee2e6;
            --gray-600: #6c757d;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* ========== Base Styles ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 20px;
        }

        /* ========== Layout ========== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .nav-bar {
            background: var(--gray-100);
            padding: 15px 40px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 10px;
        }

        .content {
            padding: 40px;
        }

        /* ========== Form Components ========== */
        .config-section {
            background: var(--gray-100);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group small {
            color: #666;
            margin-top: 5px;
        }

        /* ========== Weight Display ========== */
        .weight-total {
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
        }

        .weight-total.valid { color: var(--success-color); }
        .weight-total.invalid { color: var(--danger-color); }

        /* ========== Buttons ========== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-outline {
            background: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-load { background: var(--primary-color); color: white; }
        .btn-load:hover { background: #5568d3; }
        .btn-delete { background: var(--danger-color); color: white; }
        .btn-delete:hover { background: #c82333; }
        .btn-close { background: var(--gray-600); color: white; }
        .btn-close:hover { background: #5a6268; }
        .btn-export { background: var(--success-color); color: white; }
        .btn-export:hover { background: #218838; }

        /* ========== Results Section ========== */
        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .section-title {
            margin: 40px 0 30px 0;
            color: var(--primary-color);
        }

        .sub-title {
            margin: 30px 0 20px 0;
            color: var(--primary-color);
        }

        /* ========== Metric Cards ========== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: var(--primary-gradient);
            padding: 20px;
            border-radius: var(--border-radius);
            color: white;
            text-align: center;
        }

        .metric-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 26px;
            font-weight: bold;
        }

        .metric-card .sub {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* ========== Charts ========== */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        /* ========== Tables ========== */
        .asset-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .asset-table th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
        }

        .asset-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .asset-table tr:hover {
            background: var(--gray-100);
        }

        /* ========== Info Box ========== */
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }

        /* ========== Loading ========== */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: var(--primary-color);
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== Modal ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 1000px;
            width: 100%;
            margin: 50px 0;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            color: var(--primary-color);
        }

        /* ========== History Item ========== */
        .history-item {
            background: var(--gray-100);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .history-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .history-time {
            font-size: 14px;
            color: #666;
        }

        .history-config {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }

        .history-metrics {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .history-metric {
            font-size: 14px;
        }

        .history-metric strong {
            color: var(--primary-color);
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ========== Empty State ========== */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state p:first-child {
            font-size: 18px;
        }

        .empty-state p:last-child {
            margin-top: 10px;
        }

        /* ========== Export Actions ========== */
        .export-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ETF投资组合回测工具</h1>
            <p>自定义配置 · 智能回测 · 实时结果</p>
        </div>

        <!-- Navigation -->
        <div class="nav-bar">
            <button class="btn btn-outline" onclick="showHistory()" id="historyBtn">
                历史记录
            </button>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Portfolio Configuration -->
            <div class="config-section">
                <h3>投资配置</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>纳斯达克100 权重 (%)</label>
                        <input type="number" id="weight_nasdaq" value="40" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>标普500 权重 (%)</label>
                        <input type="number" id="weight_sp500" value="20" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>中证红利低波100 权重 (%)</label>
                        <input type="number" id="weight_csi930955" value="20" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>自由现金流指数 权重 (%)</label>
                        <input type="number" id="weight_csi980092" value="20" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>证金债指数 权重 (%)</label>
                        <input type="number" id="weight_cnb00003" value="0" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                </div>
                <div class="weight-total" id="weightTotal">总权重: 100%</div>
            </div>

            <!-- Backtest Parameters -->
            <div class="config-section">
                <h3>回测参数</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>初始资金（元）</label>
                        <input type="number" id="initial_capital" value="1000000" min="10000" step="10000">
                    </div>
                    <div class="form-group">
                        <label>开始日期</label>
                        <input type="date" id="start_date" value="2015-01-05">
                    </div>
                    <div class="form-group">
                        <label>结束日期</label>
                        <input type="date" id="end_date" value="2025-10-29">
                    </div>
                    <div class="form-group">
                        <label>定投年限</label>
                        <input type="number" id="invest_years" value="2" min="0" max="10" step="0.5">
                    </div>
                </div>
            </div>

            <!-- Rebalance Strategy -->
            <div class="config-section">
                <h3>再平衡策略</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>再平衡模式</label>
                        <select id="rebalance_mode" onchange="toggleRebalanceOptions()">
                            <option value="none">不再平衡</option>
                            <option value="periodic">定期再平衡</option>
                            <option value="threshold" selected>阈值触发再平衡</option>
                        </select>
                    </div>
                    <div class="form-group" id="periodic_option" style="display:none;">
                        <label>再平衡频率（月）</label>
                        <input type="number" id="rebalance_months" value="6" min="1" max="24">
                    </div>
                    <div class="form-group" id="threshold_option">
                        <label>相对阈值（%）</label>
                        <input type="number" id="threshold_pct" value="20" min="5" max="50" step="5">
                        <small>例如：20%权重资产，阈值=20%×20%=4%</small>
                    </div>
                </div>
                <div class="info-box">
                    <strong>提示：</strong> 相对阈值20%表示当资产偏离目标权重超过"目标×20%"时触发再平衡。
                    例如40%的资产，阈值=8%，触发范围32%-48%。
                </div>
            </div>

            <!-- Run Button -->
            <button class="btn btn-primary" onclick="runBacktest()" id="runBtn">
                开始回测
            </button>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>正在回测中，请稍候...</p>
            </div>

            <!-- Results -->
            <div id="results" class="results">
                <h2 class="section-title">回测结果</h2>

                <div class="metrics-grid" id="metricsGrid"></div>

                <!-- Export Actions -->
                <div class="export-actions">
                    <button class="btn btn-small btn-export" onclick="exportCSV()">
                        导出CSV
                    </button>
                </div>

                <h3 class="sub-title">净值走势</h3>
                <div class="chart-container">
                    <canvas id="valueChart"></canvas>
                </div>

                <h3 class="sub-title">收益率走势</h3>
                <div class="chart-container">
                    <canvas id="returnChart"></canvas>
                </div>

                <h3 class="sub-title">各资产表现</h3>
                <table class="asset-table" id="assetTable">
                    <thead>
                        <tr>
                            <th>资产</th>
                            <th>目标权重</th>
                            <th>实际权重</th>
                            <th>当前市值</th>
                            <th>利润贡献</th>
                            <th>价格涨幅</th>
                        </tr>
                    </thead>
                    <tbody id="assetTableBody"></tbody>
                </table>

                <div id="rebalanceInfo"></div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>回测历史记录</h2>
                <button class="btn btn-small btn-close" onclick="closeHistory()">关闭</button>
            </div>
            <div id="historyList"></div>
            <div id="noHistory" class="empty-state" style="display: none;">
                <p>暂无历史记录</p>
                <p>完成第一次回测后，记录会自动保存在这里</p>
            </div>
        </div>
    </div>

    <script>
    /* ========================================================================
     * ETF Portfolio Backtest Tool
     *
     * Modules:
     * 1. Config - Asset and file mapping configuration
     * 2. State - Global application state
     * 3. DataLoader - CSV data loading and caching
     * 4. BacktestEngine - Core backtest calculation logic
     * 5. MetricsCalculator - Performance metrics calculation
     * 6. UIController - UI updates and rendering
     * 7. HistoryManager - LocalStorage history management
     * 8. ExportManager - CSV export functionality
     * ======================================================================== */

    // ==================== 1. Config ====================
    const Config = {
        assets: {
            nasdaq100: { name: '纳斯达克100', file: 'nasdaq100_normalized.csv' },
            sp500: { name: '标普500', file: 'sp500_normalized.csv' },
            csi930955: { name: '中证红利低波100', file: '930955_normalized.csv' },
            csi980092: { name: '自由现金流指数', file: '980092_normalized.csv' },
            cnb00003: { name: '证金债指数', file: 'CNB00003_normalized.csv' }
        },
        dataPath: '/data/processed/',
        maxHistory: 20,
        riskFreeRate: 0.03,
        tradingDays: 252
    };

    // ==================== 2. State ====================
    const State = {
        dataCache: {},
        currentCharts: { value: null, return: null },
        currentResult: null
    };

    // ==================== 3. DataLoader ====================
    const DataLoader = {
        async load(assetKey) {
            const filename = Config.assets[assetKey].file;

            if (State.dataCache[filename]) {
                return State.dataCache[filename];
            }

            return new Promise((resolve, reject) => {
                Papa.parse(Config.dataPath + filename, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    complete: (results) => {
                        const data = results.data.filter(row => row.Date && row.Close);
                        State.dataCache[filename] = data;
                        resolve(data);
                    },
                    error: (error) => reject(error)
                });
            });
        },

        async loadAll(weights) {
            const datasets = {};
            for (const key in weights) {
                if (weights[key] > 0) {
                    datasets[key] = await this.load(key);
                }
            }
            return datasets;
        },

        getCommonDates(datasets, startDate, endDate) {
            const keys = Object.keys(datasets);
            let commonDates = new Set(datasets[keys[0]].map(d => d.Date));

            for (const key of keys) {
                const dates = new Set(datasets[key].map(d => d.Date));
                commonDates = new Set([...commonDates].filter(d => dates.has(d)));
            }

            return Array.from(commonDates)
                .filter(d => {
                    const date = new Date(d);
                    return date >= startDate && date <= endDate;
                })
                .sort();
        },

        filterByDates(datasets, dates) {
            const filtered = {};
            for (const key in datasets) {
                filtered[key] = datasets[key].filter(row => dates.includes(row.Date));
            }
            return filtered;
        }
    };

    // ==================== 4. BacktestEngine ====================
    const BacktestEngine = {
        run(config, datasets) {
            const dates = DataLoader.getCommonDates(datasets, config.startDate, config.endDate);
            const filteredData = DataLoader.filterByDates(datasets, dates);

            // Initialize
            const initialInvest = config.initialCapital * 0.2;
            const remaining = config.initialCapital - initialInvest;
            const investEndDate = new Date(dates[0]);
            investEndDate.setFullYear(investEndDate.getFullYear() + config.investYears);

            const investDates = dates.filter(d => new Date(d) <= investEndDate);
            const dailyInvest = remaining / investDates.length;

            // Initialize shares
            const shares = {};
            for (const key in config.weights) {
                if (config.weights[key] > 0) {
                    const initialPrice = filteredData[key][0].Close;
                    shares[key] = (initialInvest * config.weights[key]) / initialPrice;
                } else {
                    shares[key] = 0;
                }
            }

            const portfolio = [];
            const rebalanceLog = [];

            // Simulate trading
            for (let i = 0; i < dates.length; i++) {
                const date = dates[i];
                const currentDate = new Date(date);

                if (i > 0) {
                    if (currentDate <= investEndDate) {
                        // Regular investment period
                        this._regularInvest(shares, config.weights, filteredData, i, dailyInvest);
                    } else {
                        // Check rebalance
                        this._checkRebalance(shares, config, filteredData, i, date, rebalanceLog);
                    }
                }

                // Record portfolio value
                const record = this._recordPortfolio(shares, config, filteredData, i, date, investEndDate, initialInvest, dailyInvest);
                portfolio.push(record);
            }

            const metrics = MetricsCalculator.calculate(portfolio, config.initialCapital, dates);

            return {
                portfolio,
                metrics,
                rebalanceLog,
                dates,
                filteredData,
                shares: { ...shares }
            };
        },

        _regularInvest(shares, weights, data, idx, dailyInvest) {
            for (const key in weights) {
                if (weights[key] > 0) {
                    const price = data[key][idx].Close;
                    shares[key] += (dailyInvest * weights[key]) / price;
                }
            }
        },

        _checkRebalance(shares, config, data, idx, date, log) {
            if (config.rebalanceMode === 'threshold') {
                this._thresholdRebalance(shares, config, data, idx, date, log);
            } else if (config.rebalanceMode === 'periodic') {
                this._periodicRebalance(shares, config, data, idx, date, log);
            }
        },

        _thresholdRebalance(shares, config, data, idx, date, log) {
            const totalValue = this._getTotalValue(shares, config.weights, data, idx);
            let needRebalance = false;
            const reasons = [];

            for (const key in config.weights) {
                if (config.weights[key] > 0) {
                    const currentValue = shares[key] * data[key][idx].Close;
                    const currentWeight = currentValue / totalValue;
                    const targetWeight = config.weights[key];
                    const threshold = targetWeight * config.thresholdPct;

                    if (Math.abs(currentWeight - targetWeight) > threshold) {
                        needRebalance = true;
                        reasons.push(`${Config.assets[key].name}: ${(currentWeight*100).toFixed(1)}%`);
                    }
                }
            }

            if (needRebalance) {
                this._executeRebalance(shares, config.weights, data, idx, totalValue);
                log.push({ date, reasons: reasons.join(', ') });
            }
        },

        _periodicRebalance(shares, config, data, idx, date, log) {
            const investEndDate = new Date(config.startDate);
            investEndDate.setFullYear(investEndDate.getFullYear() + config.investYears);

            const daysSinceInvest = Math.floor((new Date(date) - investEndDate) / (1000 * 60 * 60 * 24));
            const rebalanceDays = config.rebalanceMonths * 30;

            if (daysSinceInvest > 0 && daysSinceInvest % rebalanceDays === 0) {
                const totalValue = this._getTotalValue(shares, config.weights, data, idx);
                this._executeRebalance(shares, config.weights, data, idx, totalValue);
                log.push({
                    date,
                    reasons: `定期再平衡（第${Math.floor(daysSinceInvest/rebalanceDays)}次）`
                });
            }
        },

        _executeRebalance(shares, weights, data, idx, totalValue) {
            for (const key in weights) {
                if (weights[key] > 0) {
                    const targetValue = totalValue * weights[key];
                    shares[key] = targetValue / data[key][idx].Close;
                }
            }
        },

        _getTotalValue(shares, weights, data, idx) {
            let total = 0;
            for (const key in weights) {
                if (weights[key] > 0) {
                    total += shares[key] * data[key][idx].Close;
                }
            }
            return total;
        },

        _recordPortfolio(shares, config, data, idx, date, investEndDate, initialInvest, dailyInvest) {
            let totalValue = 0;
            const assetValues = {};

            for (const key in config.weights) {
                if (config.weights[key] > 0) {
                    const value = shares[key] * data[key][idx].Close;
                    assetValues[key] = value;
                    totalValue += value;
                }
            }

            const currentDate = new Date(date);
            const cumulativeInvest = currentDate <= investEndDate
                ? initialInvest + dailyInvest * (idx + 1)
                : config.initialCapital;

            return {
                date,
                totalValue,
                assetValues,
                returnPct: (totalValue / config.initialCapital - 1) * 100,
                profit: totalValue - cumulativeInvest
            };
        }
    };

    // ==================== 5. MetricsCalculator ====================
    const MetricsCalculator = {
        calculate(portfolio, initialCapital, dates) {
            const finalValue = portfolio[portfolio.length - 1].totalValue;
            const totalReturn = portfolio[portfolio.length - 1].returnPct;

            const years = (new Date(dates[dates.length - 1]) - new Date(dates[0])) / (365.25 * 24 * 60 * 60 * 1000);
            const annualizedReturn = (Math.pow(finalValue / initialCapital, 1/years) - 1) * 100;

            const maxDrawdown = this._calculateMaxDrawdown(portfolio);
            const { volatility, downsideVol } = this._calculateVolatility(portfolio);

            const sharpe = (annualizedReturn / 100 - Config.riskFreeRate) / (volatility / 100);
            const sortino = (annualizedReturn / 100 - Config.riskFreeRate) / (downsideVol / 100);

            return {
                finalValue,
                totalReturn,
                annualizedReturn,
                maxDrawdown,
                volatility,
                downsideVol,
                sharpe,
                sortino,
                years
            };
        },

        _calculateMaxDrawdown(portfolio) {
            let maxDrawdown = 0;
            let peak = portfolio[0].totalValue;

            for (const p of portfolio) {
                if (p.totalValue > peak) peak = p.totalValue;
                const dd = (p.totalValue - peak) / peak * 100;
                if (dd < maxDrawdown) maxDrawdown = dd;
            }

            return maxDrawdown;
        },

        _calculateVolatility(portfolio) {
            const returns = [];
            for (let i = 1; i < portfolio.length; i++) {
                returns.push(portfolio[i].totalValue / portfolio[i-1].totalValue - 1);
            }

            const volatility = Math.sqrt(
                returns.reduce((sum, r) => sum + r*r, 0) / returns.length
            ) * Math.sqrt(Config.tradingDays) * 100;

            const downsideReturns = returns.filter(r => r < 0);
            const downsideVol = Math.sqrt(
                downsideReturns.reduce((sum, r) => sum + r*r, 0) / downsideReturns.length
            ) * Math.sqrt(Config.tradingDays) * 100;

            return { volatility, downsideVol };
        }
    };

    // ==================== 6. UIController ====================
    const UIController = {
        getConfig() {
            return {
                weights: {
                    nasdaq100: parseFloat(document.getElementById('weight_nasdaq').value) / 100,
                    sp500: parseFloat(document.getElementById('weight_sp500').value) / 100,
                    csi930955: parseFloat(document.getElementById('weight_csi930955').value) / 100,
                    csi980092: parseFloat(document.getElementById('weight_csi980092').value) / 100,
                    cnb00003: parseFloat(document.getElementById('weight_cnb00003').value) / 100
                },
                initialCapital: parseFloat(document.getElementById('initial_capital').value),
                startDate: new Date(document.getElementById('start_date').value),
                endDate: new Date(document.getElementById('end_date').value),
                investYears: parseFloat(document.getElementById('invest_years').value),
                rebalanceMode: document.getElementById('rebalance_mode').value,
                rebalanceMonths: parseInt(document.getElementById('rebalance_months').value),
                thresholdPct: parseFloat(document.getElementById('threshold_pct').value) / 100
            };
        },

        setConfig(config) {
            document.getElementById('weight_nasdaq').value = config.weights.nasdaq100 * 100;
            document.getElementById('weight_sp500').value = config.weights.sp500 * 100;
            document.getElementById('weight_csi930955').value = config.weights.csi930955 * 100;
            document.getElementById('weight_csi980092').value = config.weights.csi980092 * 100;
            document.getElementById('weight_cnb00003').value = config.weights.cnb00003 * 100;

            document.getElementById('initial_capital').value = config.initialCapital;
            document.getElementById('invest_years').value = config.investYears;
            document.getElementById('rebalance_mode').value = config.rebalanceMode;

            if (config.rebalanceMode === 'periodic') {
                document.getElementById('rebalance_months').value = config.rebalanceMonths;
            } else if (config.rebalanceMode === 'threshold') {
                document.getElementById('threshold_pct').value = config.thresholdPct * 100;
            }

            updateTotal();
            toggleRebalanceOptions();
        },

        showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').classList.remove('show');
        },

        hideLoading() {
            document.getElementById('loading').style.display = 'none';
        },

        showResults() {
            document.getElementById('results').classList.add('show');
        },

        showError(message) {
            alert('回测出错: ' + message);
        },

        renderMetrics(metrics) {
            const html = `
                <div class="metric-card">
                    <h4>总收益率</h4>
                    <div class="value">${metrics.totalReturn.toFixed(2)}%</div>
                    <div class="sub">年化 ${metrics.annualizedReturn.toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <h4>最终市值</h4>
                    <div class="value">¥${(metrics.finalValue/10000).toFixed(1)}万</div>
                    <div class="sub">投资 ${metrics.years.toFixed(2)} 年</div>
                </div>
                <div class="metric-card">
                    <h4>最大回撤</h4>
                    <div class="value">${metrics.maxDrawdown.toFixed(2)}%</div>
                    <div class="sub">波动率 ${metrics.volatility.toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <h4>夏普比率</h4>
                    <div class="value">${metrics.sharpe.toFixed(3)}</div>
                    <div class="sub">综合性价比</div>
                </div>
                <div class="metric-card">
                    <h4>索提诺比率</h4>
                    <div class="value">${metrics.sortino.toFixed(3)}</div>
                    <div class="sub">下行风险 ${metrics.downsideVol.toFixed(2)}%</div>
                </div>
            `;
            document.getElementById('metricsGrid').innerHTML = html;
        },

        renderCharts(portfolio) {
            // Destroy existing charts
            if (State.currentCharts.value) State.currentCharts.value.destroy();
            if (State.currentCharts.return) State.currentCharts.return.destroy();

            // Value chart
            State.currentCharts.value = new Chart(document.getElementById('valueChart'), {
                type: 'line',
                data: {
                    labels: portfolio.map(p => p.date),
                    datasets: [{
                        label: '投资组合净值',
                        data: portfolio.map(p => p.totalValue),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, ticks: { maxTicksLimit: 10 } },
                        y: {
                            beginAtZero: false,
                            ticks: { callback: value => '¥' + (value/10000).toFixed(0) + '万' }
                        }
                    }
                }
            });

            // Return chart
            State.currentCharts.return = new Chart(document.getElementById('returnChart'), {
                type: 'line',
                data: {
                    labels: portfolio.map(p => p.date),
                    datasets: [{
                        label: '累计收益率',
                        data: portfolio.map(p => p.returnPct),
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, ticks: { maxTicksLimit: 10 } },
                        y: { ticks: { callback: value => value.toFixed(0) + '%' } }
                    }
                }
            });
        },

        renderAssetTable(result, config) {
            const lastPortfolio = result.portfolio[result.portfolio.length - 1];
            let html = '';

            for (const key in config.weights) {
                if (config.weights[key] > 0) {
                    const currentValue = lastPortfolio.assetValues[key];
                    const currentWeight = currentValue / lastPortfolio.totalValue * 100;
                    const targetWeight = config.weights[key] * 100;

                    const initialPrice = result.filteredData[key][0].Close;
                    const finalPrice = result.filteredData[key][result.filteredData[key].length - 1].Close;
                    const priceReturn = (finalPrice / initialPrice - 1) * 100;

                    const initialValue = result.shares[key] * initialPrice;
                    const profit = currentValue - initialValue;

                    html += `
                        <tr>
                            <td><strong>${Config.assets[key].name}</strong></td>
                            <td>${targetWeight.toFixed(1)}%</td>
                            <td>${currentWeight.toFixed(2)}%</td>
                            <td>¥${(currentValue/10000).toFixed(1)}万</td>
                            <td>¥${(profit/10000).toFixed(1)}万</td>
                            <td>${priceReturn.toFixed(2)}%</td>
                        </tr>
                    `;
                }
            }

            document.getElementById('assetTableBody').innerHTML = html;
        },

        renderRebalanceInfo(rebalanceLog) {
            const el = document.getElementById('rebalanceInfo');

            if (rebalanceLog.length > 0) {
                let html = '<h3 class="sub-title">再平衡记录</h3>';
                html += '<div class="info-box">';
                html += `<p><strong>再平衡次数: ${rebalanceLog.length}次</strong></p>`;
                html += '<ul style="margin-top: 10px; padding-left: 20px;">';
                rebalanceLog.forEach(log => {
                    html += `<li>${log.date}: ${log.reasons}</li>`;
                });
                html += '</ul></div>';
                el.innerHTML = html;
            } else {
                el.innerHTML = '<div class="info-box">未触发再平衡</div>';
            }
        }
    };

    // ==================== 7. HistoryManager ====================
    const HistoryManager = {
        save(config, result) {
            const history = this.load();

            const record = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('zh-CN'),
                config: config,
                metrics: result.metrics,
                rebalanceCount: result.rebalanceLog.length
            };

            history.unshift(record);
            if (history.length > Config.maxHistory) history.pop();

            localStorage.setItem('backtestHistory', JSON.stringify(history));
            this.updateBadge();
        },

        load() {
            return JSON.parse(localStorage.getItem('backtestHistory') || '[]');
        },

        delete(id) {
            let history = this.load();
            history = history.filter(item => item.id !== id);
            localStorage.setItem('backtestHistory', JSON.stringify(history));
            this.render();
            this.updateBadge();
        },

        loadConfig(id) {
            const history = this.load();
            const record = history.find(item => item.id === id);

            if (record) {
                UIController.setConfig(record.config);
                closeHistory();
                alert('配置已加载，点击"开始回测"运行');
            }
        },

        updateBadge() {
            const history = this.load();
            const btn = document.getElementById('historyBtn');
            btn.textContent = history.length > 0
                ? `历史记录 (${history.length})`
                : '历史记录';
        },

        render() {
            const history = this.load();
            const listEl = document.getElementById('historyList');
            const noHistoryEl = document.getElementById('noHistory');

            if (history.length === 0) {
                listEl.innerHTML = '';
                noHistoryEl.style.display = 'block';
                return;
            }

            noHistoryEl.style.display = 'none';

            let html = '';
            history.forEach((record, index) => {
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-title">回测 #${history.length - index}</div>
                            <div class="history-time">${record.timestamp}</div>
                        </div>
                        <div class="history-config">
                            <strong>配置:</strong> ${this._getWeightDesc(record.config.weights)} |
                            ${this._getModeDesc(record.config)} |
                            定投${record.config.investYears}年
                        </div>
                        <div class="history-metrics">
                            <div class="history-metric"><strong>收益:</strong> ${record.metrics.totalReturn.toFixed(2)}%</div>
                            <div class="history-metric"><strong>年化:</strong> ${record.metrics.annualizedReturn.toFixed(2)}%</div>
                            <div class="history-metric"><strong>回撤:</strong> ${record.metrics.maxDrawdown.toFixed(2)}%</div>
                            <div class="history-metric"><strong>夏普:</strong> ${record.metrics.sharpe.toFixed(3)}</div>
                            <div class="history-metric"><strong>索提诺:</strong> ${record.metrics.sortino.toFixed(3)}</div>
                            <div class="history-metric"><strong>再平衡:</strong> ${record.rebalanceCount}次</div>
                        </div>
                        <div class="history-actions">
                            <button class="btn btn-small btn-load" onclick="HistoryManager.loadConfig(${record.id})">
                                加载配置
                            </button>
                            <button class="btn btn-small btn-delete" onclick="if(confirm('确定删除此记录?')) HistoryManager.delete(${record.id})">
                                删除
                            </button>
                        </div>
                    </div>
                `;
            });

            listEl.innerHTML = html;
        },

        _getWeightDesc(weights) {
            const parts = [];
            if (weights.nasdaq100 > 0) parts.push(`纳${(weights.nasdaq100*100).toFixed(0)}%`);
            if (weights.sp500 > 0) parts.push(`标${(weights.sp500*100).toFixed(0)}%`);
            if (weights.csi930955 > 0) parts.push(`红${(weights.csi930955*100).toFixed(0)}%`);
            if (weights.csi980092 > 0) parts.push(`流${(weights.csi980092*100).toFixed(0)}%`);
            if (weights.cnb00003 > 0) parts.push(`债${(weights.cnb00003*100).toFixed(0)}%`);
            return parts.join(' + ');
        },

        _getModeDesc(config) {
            if (config.rebalanceMode === 'none') return '不再平衡';
            if (config.rebalanceMode === 'periodic') return `定期(${config.rebalanceMonths}月)`;
            return `阈值(${(config.thresholdPct*100).toFixed(0)}%)`;
        }
    };

    // ==================== 8. ExportManager ====================
    const ExportManager = {
        toCSV() {
            if (!State.currentResult) {
                alert('请先运行回测');
                return;
            }

            const { portfolio, rebalanceLog } = State.currentResult;

            let csv = 'Date,TotalValue,Return(%),Profit\n';
            for (const p of portfolio) {
                csv += `${p.date},${p.totalValue.toFixed(2)},${p.returnPct.toFixed(2)},${p.profit.toFixed(2)}\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backtest_result_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
    };

    // ==================== Global Functions ====================
    function updateTotal() {
        const weights = [
            parseFloat(document.getElementById('weight_nasdaq').value) || 0,
            parseFloat(document.getElementById('weight_sp500').value) || 0,
            parseFloat(document.getElementById('weight_csi930955').value) || 0,
            parseFloat(document.getElementById('weight_csi980092').value) || 0,
            parseFloat(document.getElementById('weight_cnb00003').value) || 0
        ];

        const total = weights.reduce((a, b) => a + b, 0);
        const totalEl = document.getElementById('weightTotal');
        totalEl.textContent = `总权重: ${total.toFixed(1)}%`;

        if (Math.abs(total - 100) < 0.1) {
            totalEl.className = 'weight-total valid';
            document.getElementById('runBtn').disabled = false;
        } else {
            totalEl.className = 'weight-total invalid';
            document.getElementById('runBtn').disabled = true;
        }
    }

    function toggleRebalanceOptions() {
        const mode = document.getElementById('rebalance_mode').value;
        document.getElementById('periodic_option').style.display = mode === 'periodic' ? 'block' : 'none';
        document.getElementById('threshold_option').style.display = mode === 'threshold' ? 'block' : 'none';
    }

    async function runBacktest() {
        const btn = document.getElementById('runBtn');
        const originalText = btn.textContent;

        // 禁用按钮，显示加载状态
        btn.disabled = true;
        btn.textContent = '回测中...';

        UIController.showLoading();

        try {
            const config = UIController.getConfig();
            const datasets = await DataLoader.loadAll(config.weights);
            const result = BacktestEngine.run(config, datasets);

            State.currentResult = result;

            UIController.renderMetrics(result.metrics);
            UIController.renderCharts(result.portfolio);
            UIController.renderAssetTable(result, config);
            UIController.renderRebalanceInfo(result.rebalanceLog);

            HistoryManager.save(config, result);

            UIController.hideLoading();
            UIController.showResults();

        } catch (error) {
            console.error(error);
            UIController.showError(error.message);
            UIController.hideLoading();
        } finally {
            // 恢复按钮状态
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    function showHistory() {
        HistoryManager.render();
        document.getElementById('historyModal').classList.add('show');
    }

    function closeHistory() {
        document.getElementById('historyModal').classList.remove('show');
    }

    function exportCSV() {
        ExportManager.toCSV();
    }

    // ==================== Initialize ====================
    document.addEventListener('DOMContentLoaded', () => {
        updateTotal();
        toggleRebalanceOptions();
        HistoryManager.updateBadge();
    });
    </script>
</body>
</html>
