<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETFæŠ•èµ„ç»„åˆå›æµ‹å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .config-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .config-section h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .weight-total {
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .weight-total.valid {
            color: #28a745;
        }
        
        .weight-total.invalid {
            color: #dc3545;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }
        
        .metric-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .metric-card .value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .metric-card .sub {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .asset-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .asset-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .asset-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .asset-table tr:hover {
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #667eea;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .history-modal.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .history-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 1000px;
            width: 100%;
            margin: 50px 0;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .history-time {
            font-size: 14px;
            color: #666;
        }
        
        .history-config {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        
        .history-metrics {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .history-metric {
            font-size: 14px;
        }
        
        .history-metric strong {
            color: #667eea;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-load {
            background: #667eea;
            color: white;
        }
        
        .btn-load:hover {
            background: #5568d3;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .btn-close {
            background: #6c757d;
            color: white;
        }
        
        .btn-close:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ETFæŠ•èµ„ç»„åˆå›æµ‹å·¥å…·</h1>
            <p>è‡ªå®šä¹‰é…ç½® Â· æ™ºèƒ½å›æµ‹ Â· å®æ—¶ç»“æœ</p>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px 40px; border-bottom: 1px solid #dee2e6;">
            <button class="nav-btn" onclick="showHistory()" id="historyBtn" style="background: white; border: 2px solid #667eea; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ“š å†å²è®°å½•
            </button>
        </div>
        
        <div class="content">
            <!-- é…ç½®åŒºåŸŸ -->
            <div class="config-section">
                <h3>ğŸ“Š æŠ•èµ„é…ç½®</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>çº³æ–¯è¾¾å…‹100 æƒé‡ (%)</label>
                        <input type="number" id="weight_nasdaq" value="40" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>æ ‡æ™®500 æƒé‡ (%)</label>
                        <input type="number" id="weight_sp500" value="20" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>ä¸­è¯çº¢åˆ©ä½æ³¢100 æƒé‡ (%)</label>
                        <input type="number" id="weight_csi930955" value="20" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>è‡ªç”±ç°é‡‘æµæŒ‡æ•° æƒé‡ (%)</label>
                        <input type="number" id="weight_csi980092" value="20" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                    <div class="form-group">
                        <label>è¯é‡‘å€ºæŒ‡æ•° æƒé‡ (%)</label>
                        <input type="number" id="weight_cnb00003" value="0" min="0" max="100" step="0.5" onchange="updateTotal()">
                    </div>
                </div>
                
                <div class="weight-total" id="weightTotal">æ€»æƒé‡: 100%</div>
            </div>
            
            <div class="config-section">
                <h3>âš™ï¸ å›æµ‹å‚æ•°</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>åˆå§‹èµ„é‡‘ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="initial_capital" value="1000000" min="10000" step="10000">
                    </div>
                    <div class="form-group">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="start_date" value="2015-01-05">
                    </div>
                    <div class="form-group">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="end_date" value="2025-10-29">
                    </div>
                    <div class="form-group">
                        <label>å®šæŠ•å¹´é™</label>
                        <input type="number" id="invest_years" value="2" min="0" max="10" step="0.5">
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <h3>ğŸ”„ å†å¹³è¡¡ç­–ç•¥</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>å†å¹³è¡¡æ¨¡å¼</label>
                        <select id="rebalance_mode" onchange="toggleRebalanceOptions()">
                            <option value="none">ä¸å†å¹³è¡¡</option>
                            <option value="periodic">å®šæœŸå†å¹³è¡¡</option>
                            <option value="threshold" selected>é˜ˆå€¼è§¦å‘å†å¹³è¡¡</option>
                        </select>
                    </div>
                    <div class="form-group" id="periodic_option" style="display:none;">
                        <label>å†å¹³è¡¡é¢‘ç‡ï¼ˆæœˆï¼‰</label>
                        <input type="number" id="rebalance_months" value="6" min="1" max="24">
                    </div>
                    <div class="form-group" id="threshold_option">
                        <label>ç›¸å¯¹é˜ˆå€¼ï¼ˆ%ï¼‰</label>
                        <input type="number" id="threshold_pct" value="20" min="5" max="50" step="5">
                        <small style="color: #666; margin-top: 5px;">ä¾‹å¦‚ï¼š20%æƒé‡èµ„äº§ï¼Œé˜ˆå€¼=20%Ã—20%=4%</small>
                    </div>
                </div>
                
                <div class="info-box">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong> ç›¸å¯¹é˜ˆå€¼20%è¡¨ç¤ºå½“èµ„äº§åç¦»ç›®æ ‡æƒé‡è¶…è¿‡"ç›®æ ‡Ã—20%"æ—¶è§¦å‘å†å¹³è¡¡ã€‚
                    ä¾‹å¦‚40%çš„èµ„äº§ï¼Œé˜ˆå€¼=8%ï¼Œè§¦å‘èŒƒå›´32%-48%ã€‚
                </div>
            </div>
            
            <button class="btn-primary" onclick="runBacktest()" id="runBtn">
                ğŸš€ å¼€å§‹å›æµ‹
            </button>
            
            <!-- ç»“æœåŒºåŸŸ -->
            <div id="results" class="results">
                <h2 style="margin: 40px 0 30px 0; color: #667eea;">ğŸ“ˆ å›æµ‹ç»“æœ</h2>
                
                <div class="metrics-grid" id="metricsGrid"></div>
                
                <h3 style="margin: 30px 0 20px 0; color: #667eea;">å‡€å€¼èµ°åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="valueChart"></canvas>
                </div>
                
                <h3 style="margin: 30px 0 20px 0; color: #667eea;">æ”¶ç›Šç‡èµ°åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="returnChart"></canvas>
                </div>
                
                <h3 style="margin: 30px 0 20px 0; color: #667eea;">å„èµ„äº§è¡¨ç°</h3>
                <table class="asset-table" id="assetTable">
                    <thead>
                        <tr>
                            <th>èµ„äº§</th>
                            <th>ç›®æ ‡æƒé‡</th>
                            <th>å®é™…æƒé‡</th>
                            <th>å½“å‰å¸‚å€¼</th>
                            <th>åˆ©æ¶¦è´¡çŒ®</th>
                            <th>ä»·æ ¼æ¶¨å¹…</th>
                        </tr>
                    </thead>
                    <tbody id="assetTableBody"></tbody>
                </table>
                
                <div id="rebalanceInfo"></div>
            </div>
            
            <!-- åŠ è½½æç¤º -->
            <div id="loading" class="loading" style="display:none;">
                <div class="spinner"></div>
                <p>æ­£åœ¨å›æµ‹ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>
    
    <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
    <div id="historyModal" class="history-modal">
        <div class="history-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #667eea;">ğŸ“š å›æµ‹å†å²è®°å½•</h2>
                <button class="btn-small btn-close" onclick="closeHistory()">å…³é—­</button>
            </div>
            
            <div id="historyList">
                <!-- å†å²è®°å½•åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div id="noHistory" style="text-align: center; padding: 40px; color: #999; display: none;">
                <p style="font-size: 18px;">ğŸ“­ æš‚æ— å†å²è®°å½•</p>
                <p style="margin-top: 10px;">å®Œæˆç¬¬ä¸€æ¬¡å›æµ‹åï¼Œè®°å½•ä¼šè‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ</p>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let dataCache = {};
        let currentChart1 = null;
        let currentChart2 = null;
        let currentResult = null;
        
        // å†å²è®°å½•ç®¡ç†
        function saveToHistory(config, result) {
            const history = JSON.parse(localStorage.getItem('backtestHistory') || '[]');
            
            const record = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('zh-CN'),
                config: config,
                metrics: result.metrics,
                rebalanceCount: result.rebalanceLog.length
            };
            
            history.unshift(record); // æ·»åŠ åˆ°å¼€å¤´
            
            // æœ€å¤šä¿å­˜20æ¡è®°å½•
            if (history.length > 20) {
                history.pop();
            }
            
            localStorage.setItem('backtestHistory', JSON.stringify(history));
        }
        
        function loadHistory() {
            return JSON.parse(localStorage.getItem('backtestHistory') || '[]');
        }
        
        function deleteHistory(id) {
            let history = loadHistory();
            history = history.filter(item => item.id !== id);
            localStorage.setItem('backtestHistory', JSON.stringify(history));
            renderHistory();
        }
        
        function loadHistoryConfig(id) {
            const history = loadHistory();
            const record = history.find(item => item.id === id);
            
            if (record) {
                const config = record.config;
                
                // åŠ è½½é…ç½®åˆ°è¡¨å•
                document.getElementById('weight_nasdaq').value = config.weights.nasdaq100 * 100;
                document.getElementById('weight_sp500').value = config.weights.sp500 * 100;
                document.getElementById('weight_csi930955').value = config.weights.csi930955 * 100;
                document.getElementById('weight_csi980092').value = config.weights.csi980092 * 100;
                document.getElementById('weight_cnb00003').value = config.weights.cnb00003 * 100;
                
                document.getElementById('initial_capital').value = config.initialCapital;
                document.getElementById('start_date').value = config.startDate.toISOString().split('T')[0];
                document.getElementById('end_date').value = config.endDate.toISOString().split('T')[0];
                document.getElementById('invest_years').value = config.investYears;
                
                document.getElementById('rebalance_mode').value = config.rebalanceMode;
                toggleRebalanceOptions();
                
                if (config.rebalanceMode === 'periodic') {
                    document.getElementById('rebalance_months').value = config.rebalanceMonths;
                } else if (config.rebalanceMode === 'threshold') {
                    document.getElementById('threshold_pct').value = config.thresholdPct * 100;
                }
                
                updateTotal();
                closeHistory();
                
                // æç¤ºç”¨æˆ·
                alert('é…ç½®å·²åŠ è½½ï¼Œç‚¹å‡»"å¼€å§‹å›æµ‹"è¿è¡Œ');
            }
        }
        
        function showHistory() {
            renderHistory();
            document.getElementById('historyModal').classList.add('show');
        }
        
        function closeHistory() {
            document.getElementById('historyModal').classList.remove('show');
        }
        
        function updateHistoryBadge() {
            const history = loadHistory();
            const btn = document.getElementById('historyBtn');
            if (history.length > 0) {
                btn.textContent = `ğŸ“š å†å²è®°å½• (${history.length})`;
            } else {
                btn.textContent = 'ğŸ“š å†å²è®°å½•';
            }
        }
        
        function renderHistory() {
            const history = loadHistory();
            const listEl = document.getElementById('historyList');
            const noHistoryEl = document.getElementById('noHistory');
            
            if (history.length === 0) {
                listEl.innerHTML = '';
                noHistoryEl.style.display = 'block';
                return;
            }
            
            noHistoryEl.style.display = 'none';
            
            const getWeightDesc = (weights) => {
                const parts = [];
                if (weights.nasdaq100 > 0) parts.push(`çº³${(weights.nasdaq100*100).toFixed(0)}%`);
                if (weights.sp500 > 0) parts.push(`æ ‡${(weights.sp500*100).toFixed(0)}%`);
                if (weights.csi930955 > 0) parts.push(`çº¢${(weights.csi930955*100).toFixed(0)}%`);
                if (weights.csi980092 > 0) parts.push(`æµ${(weights.csi980092*100).toFixed(0)}%`);
                if (weights.cnb00003 > 0) parts.push(`å€º${(weights.cnb00003*100).toFixed(0)}%`);
                return parts.join(' + ');
            };
            
            const getModeDesc = (config) => {
                if (config.rebalanceMode === 'none') return 'ä¸å†å¹³è¡¡';
                if (config.rebalanceMode === 'periodic') return `å®šæœŸ(${config.rebalanceMonths}æœˆ)`;
                return `é˜ˆå€¼(${(config.thresholdPct*100).toFixed(0)}%)`;
            };
            
            let html = '';
            history.forEach((record, index) => {
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-title">å›æµ‹ #${history.length - index}</div>
                            <div class="history-time">${record.timestamp}</div>
                        </div>
                        <div class="history-config">
                            <strong>é…ç½®:</strong> ${getWeightDesc(record.config.weights)} | 
                            ${getModeDesc(record.config)} | 
                            å®šæŠ•${record.config.investYears}å¹´
                        </div>
                        <div class="history-metrics">
                            <div class="history-metric"><strong>æ”¶ç›Š:</strong> ${record.metrics.totalReturn.toFixed(2)}%</div>
                            <div class="history-metric"><strong>å¹´åŒ–:</strong> ${record.metrics.annualizedReturn.toFixed(2)}%</div>
                            <div class="history-metric"><strong>å›æ’¤:</strong> ${record.metrics.maxDrawdown.toFixed(2)}%</div>
                            <div class="history-metric"><strong>å¤æ™®:</strong> ${record.metrics.sharpe.toFixed(3)}</div>
                            <div class="history-metric"><strong>ç´¢æè¯º:</strong> ${record.metrics.sortino.toFixed(3)}</div>
                            <div class="history-metric"><strong>å†å¹³è¡¡:</strong> ${record.rebalanceCount}æ¬¡</div>
                        </div>
                        <div class="history-actions">
                            <button class="btn-small btn-load" onclick="loadHistoryConfig(${record.id})">
                                ğŸ“¥ åŠ è½½é…ç½®
                            </button>
                            <button class="btn-small btn-delete" onclick="if(confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•?')) deleteHistory(${record.id})">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        // æ›´æ–°æƒé‡æ€»å’Œ
        function updateTotal() {
            const weights = [
                parseFloat(document.getElementById('weight_nasdaq').value) || 0,
                parseFloat(document.getElementById('weight_sp500').value) || 0,
                parseFloat(document.getElementById('weight_csi930955').value) || 0,
                parseFloat(document.getElementById('weight_csi980092').value) || 0,
                parseFloat(document.getElementById('weight_cnb00003').value) || 0
            ];
            
            const total = weights.reduce((a, b) => a + b, 0);
            const totalEl = document.getElementById('weightTotal');
            totalEl.textContent = `æ€»æƒé‡: ${total.toFixed(1)}%`;
            
            if (Math.abs(total - 100) < 0.1) {
                totalEl.className = 'weight-total valid';
                document.getElementById('runBtn').disabled = false;
            } else {
                totalEl.className = 'weight-total invalid';
                document.getElementById('runBtn').disabled = true;
            }
        }
        
        // åˆ‡æ¢å†å¹³è¡¡é€‰é¡¹
        function toggleRebalanceOptions() {
            const mode = document.getElementById('rebalance_mode').value;
            document.getElementById('periodic_option').style.display = 
                mode === 'periodic' ? 'block' : 'none';
            document.getElementById('threshold_option').style.display = 
                mode === 'threshold' ? 'block' : 'none';
        }
        
        // åŠ è½½CSVæ•°æ®
        async function loadData(filename) {
            if (dataCache[filename]) {
                return dataCache[filename];
            }
            
            return new Promise((resolve, reject) => {
                Papa.parse(`/data/processed/${filename}`, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        const data = results.data.filter(row => row.Date);
                        dataCache[filename] = data;
                        resolve(data);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        // ä¸»å›æµ‹å‡½æ•°
        async function runBacktest() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').classList.remove('show');
            
            try {
                // è·å–é…ç½®
                const config = {
                    weights: {
                        nasdaq100: parseFloat(document.getElementById('weight_nasdaq').value) / 100,
                        sp500: parseFloat(document.getElementById('weight_sp500').value) / 100,
                        csi930955: parseFloat(document.getElementById('weight_csi930955').value) / 100,
                        csi980092: parseFloat(document.getElementById('weight_csi980092').value) / 100,
                        cnb00003: parseFloat(document.getElementById('weight_cnb00003').value) / 100
                    },
                    initialCapital: parseFloat(document.getElementById('initial_capital').value),
                    startDate: new Date(document.getElementById('start_date').value),
                    endDate: new Date(document.getElementById('end_date').value),
                    investYears: parseFloat(document.getElementById('invest_years').value),
                    rebalanceMode: document.getElementById('rebalance_mode').value,
                    rebalanceMonths: parseInt(document.getElementById('rebalance_months').value),
                    thresholdPct: parseFloat(document.getElementById('threshold_pct').value) / 100
                };
                
                // åŠ è½½æ•°æ®
                const datasets = {};
                for (let key in config.weights) {
                    if (config.weights[key] > 0) {
                        const filename = key === 'nasdaq100' ? 'nasdaq100_normalized.csv' :
                                       key === 'sp500' ? 'sp500_normalized.csv' :
                                       key === 'csi930955' ? '930955_normalized.csv' :
                                       key === 'csi980092' ? '980092_normalized.csv' :
                                       'CNB00003_normalized.csv';
                        datasets[key] = await loadData(filename);
                    }
                }
                
                // æ‰§è¡Œå›æµ‹
                const result = performBacktest(config, datasets);
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(result, config);
                
                // ä¿å­˜åˆ°å†å²è®°å½•
                saveToHistory(config, result);
                
                // æ›´æ–°å†å²æŒ‰é’®æ˜¾ç¤º
                updateHistoryBadge();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').classList.add('show');
                
            } catch (error) {
                alert('å›æµ‹å‡ºé”™: ' + error.message);
                console.error(error);
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // æ‰§è¡Œå›æµ‹è®¡ç®—
        function performBacktest(config, datasets) {
            // å¯¹é½æ—¥æœŸ
            let commonDates = new Set(datasets[Object.keys(datasets)[0]].map(d => d.Date));
            for (let key in datasets) {
                const dates = new Set(datasets[key].map(d => d.Date));
                commonDates = new Set([...commonDates].filter(d => dates.has(d)));
            }
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            let dates = Array.from(commonDates)
                .filter(d => {
                    const date = new Date(d);
                    return date >= config.startDate && date <= config.endDate;
                })
                .sort();
            
            // è¿‡æ»¤æ•°æ®
            const filteredData = {};
            for (let key in datasets) {
                filteredData[key] = datasets[key].filter(row => dates.includes(row.Date));
            }
            
            // åˆå§‹åŒ–
            const initialInvest = config.initialCapital * 0.2;
            const remaining = config.initialCapital - initialInvest;
            const investEndDate = new Date(dates[0]);
            investEndDate.setFullYear(investEndDate.getFullYear() + config.investYears);
            
            const investDates = dates.filter(d => new Date(d) <= investEndDate);
            const dailyInvest = remaining / investDates.length;
            
            // åˆå§‹åŒ–æŒä»“
            const shares = {};
            const portfolio = [];
            const rebalanceLog = [];
            
            for (let key in config.weights) {
                if (config.weights[key] > 0) {
                    const initialPrice = filteredData[key][0].Close;
                    shares[key] = (initialInvest * config.weights[key]) / initialPrice;
                } else {
                    shares[key] = 0;
                }
            }
            
            // æ¨¡æ‹Ÿäº¤æ˜“
            for (let i = 0; i < dates.length; i++) {
                const date = dates[i];
                const currentDate = new Date(date);
                
                if (i > 0) {
                    // å®šæŠ•æœŸ
                    if (currentDate <= investEndDate) {
                        for (let key in config.weights) {
                            if (config.weights[key] > 0) {
                                const price = filteredData[key][i].Close;
                                shares[key] += (dailyInvest * config.weights[key]) / price;
                            }
                        }
                    } else {
                        // æ£€æŸ¥å†å¹³è¡¡
                        if (config.rebalanceMode === 'threshold') {
                            const totalValue = Object.keys(shares).reduce((sum, key) => {
                                return config.weights[key] > 0 ? 
                                    sum + shares[key] * filteredData[key][i].Close : sum;
                            }, 0);
                            
                            let needRebalance = false;
                            let reasons = [];
                            
                            for (let key in config.weights) {
                                if (config.weights[key] > 0) {
                                    const currentValue = shares[key] * filteredData[key][i].Close;
                                    const currentWeight = currentValue / totalValue;
                                    const targetWeight = config.weights[key];
                                    const threshold = targetWeight * config.thresholdPct;
                                    
                                    if (Math.abs(currentWeight - targetWeight) > threshold) {
                                        needRebalance = true;
                                        reasons.push(`${key}: ${(currentWeight*100).toFixed(1)}%`);
                                    }
                                }
                            }
                            
                            if (needRebalance) {
                                // æ‰§è¡Œå†å¹³è¡¡
                                for (let key in config.weights) {
                                    if (config.weights[key] > 0) {
                                        const targetValue = totalValue * config.weights[key];
                                        shares[key] = targetValue / filteredData[key][i].Close;
                                    }
                                }
                                rebalanceLog.push({ date, reasons: reasons.join(', ') });
                            }
                        } else if (config.rebalanceMode === 'periodic') {
                            // å®šæœŸå†å¹³è¡¡
                            // è®¡ç®—è·ç¦»å®šæŠ•ç»“æŸçš„å¤©æ•°
                            const daysSinceInvest = Math.floor((currentDate - investEndDate) / (1000 * 60 * 60 * 24));
                            const rebalanceDays = config.rebalanceMonths * 30;
                            
                            // æ£€æŸ¥æ˜¯å¦åˆ°äº†å†å¹³è¡¡æ—¥ï¼ˆæ¯Nä¸ªæœˆçš„ç¬¬ä¸€å¤©ï¼‰
                            if (daysSinceInvest > 0 && daysSinceInvest % rebalanceDays === 0) {
                                const totalValue = Object.keys(shares).reduce((sum, key) => {
                                    return config.weights[key] > 0 ? 
                                        sum + shares[key] * filteredData[key][i].Close : sum;
                                }, 0);
                                
                                for (let key in config.weights) {
                                    if (config.weights[key] > 0) {
                                        const targetValue = totalValue * config.weights[key];
                                        shares[key] = targetValue / filteredData[key][i].Close;
                                    }
                                }
                                rebalanceLog.push({ 
                                    date, 
                                    reasons: `å®šæœŸå†å¹³è¡¡ï¼ˆç¬¬${Math.floor(daysSinceInvest/rebalanceDays)}æ¬¡ï¼‰` 
                                });
                            }
                        }
                    }
                }
                
                // è®°å½•å½“æ—¥ç»„åˆä»·å€¼
                let totalValue = 0;
                const assetValues = {};
                for (let key in config.weights) {
                    if (config.weights[key] > 0) {
                        const value = shares[key] * filteredData[key][i].Close;
                        assetValues[key] = value;
                        totalValue += value;
                    }
                }
                
                const cumulativeInvest = currentDate <= investEndDate ?
                    initialInvest + dailyInvest * (i + 1) : config.initialCapital;
                
                portfolio.push({
                    date,
                    totalValue,
                    assetValues,
                    returnPct: (totalValue / config.initialCapital - 1) * 100,
                    profit: totalValue - cumulativeInvest
                });
            }
            
            // è®¡ç®—æŒ‡æ ‡
            const finalValue = portfolio[portfolio.length - 1].totalValue;
            const totalReturn = portfolio[portfolio.length - 1].returnPct;
            
            const years = (new Date(dates[dates.length - 1]) - new Date(dates[0])) / (365.25 * 24 * 60 * 60 * 1000);
            const annualizedReturn = (Math.pow(finalValue / config.initialCapital, 1/years) - 1) * 100;
            
            // è®¡ç®—æœ€å¤§å›æ’¤
            let maxDrawdown = 0;
            let peak = portfolio[0].totalValue;
            for (let p of portfolio) {
                if (p.totalValue > peak) peak = p.totalValue;
                const dd = (p.totalValue - peak) / peak * 100;
                if (dd < maxDrawdown) maxDrawdown = dd;
            }
            
            // è®¡ç®—æ³¢åŠ¨ç‡
            const returns = [];
            for (let i = 1; i < portfolio.length; i++) {
                returns.push(portfolio[i].totalValue / portfolio[i-1].totalValue - 1);
            }
            const volatility = Math.sqrt(returns.reduce((sum, r) => sum + r*r, 0) / returns.length) * Math.sqrt(252) * 100;
            
            // ä¸‹è¡Œæ³¢åŠ¨
            const downsideReturns = returns.filter(r => r < 0);
            const downsideVol = Math.sqrt(downsideReturns.reduce((sum, r) => sum + r*r, 0) / downsideReturns.length) * Math.sqrt(252) * 100;
            
            // å¤æ™®å’Œç´¢æè¯º
            const sharpe = (annualizedReturn / 100 - 0.03) / (volatility / 100);
            const sortino = (annualizedReturn / 100 - 0.03) / (downsideVol / 100);
            
            return {
                portfolio,
                metrics: {
                    finalValue,
                    totalReturn,
                    annualizedReturn,
                    maxDrawdown,
                    volatility,
                    downsideVol,
                    sharpe,
                    sortino,
                    years
                },
                rebalanceLog,
                dates,
                filteredData,
                shares
            };
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(result, config) {
            const { portfolio, metrics, rebalanceLog, dates, filteredData, shares } = result;
            
            // æ˜¾ç¤ºæŒ‡æ ‡å¡ç‰‡
            const metricsHTML = `
                <div class="metric-card">
                    <h4>æ€»æ”¶ç›Šç‡</h4>
                    <div class="value">${metrics.totalReturn.toFixed(2)}%</div>
                    <div class="sub">å¹´åŒ– ${metrics.annualizedReturn.toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <h4>æœ€ç»ˆå¸‚å€¼</h4>
                    <div class="value">Â¥${(metrics.finalValue/10000).toFixed(1)}ä¸‡</div>
                    <div class="sub">æŠ•èµ„ ${metrics.years.toFixed(2)} å¹´</div>
                </div>
                <div class="metric-card">
                    <h4>æœ€å¤§å›æ’¤</h4>
                    <div class="value">${metrics.maxDrawdown.toFixed(2)}%</div>
                    <div class="sub">æ³¢åŠ¨ç‡ ${metrics.volatility.toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <h4>å¤æ™®æ¯”ç‡</h4>
                    <div class="value">${metrics.sharpe.toFixed(3)}</div>
                    <div class="sub">ç»¼åˆæ€§ä»·æ¯”</div>
                </div>
                <div class="metric-card">
                    <h4>ç´¢æè¯ºæ¯”ç‡</h4>
                    <div class="value">${metrics.sortino.toFixed(3)}</div>
                    <div class="sub">ä¸‹è¡Œé£é™© ${metrics.downsideVol.toFixed(2)}%</div>
                </div>
            `;
            document.getElementById('metricsGrid').innerHTML = metricsHTML;
            
            // ç»˜åˆ¶å‡€å€¼å›¾
            if (currentChart1) currentChart1.destroy();
            currentChart1 = new Chart(document.getElementById('valueChart'), {
                type: 'line',
                data: {
                    labels: portfolio.map(p => p.date),
                    datasets: [{
                        label: 'æŠ•èµ„ç»„åˆå‡€å€¼',
                        data: portfolio.map(p => p.totalValue),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'Â¥' + (value/10000).toFixed(0) + 'ä¸‡'
                            }
                        }
                    }
                }
            });
            
            // ç»˜åˆ¶æ”¶ç›Šç‡å›¾
            if (currentChart2) currentChart2.destroy();
            currentChart2 = new Chart(document.getElementById('returnChart'), {
                type: 'line',
                data: {
                    labels: portfolio.map(p => p.date),
                    datasets: [{
                        label: 'ç´¯è®¡æ”¶ç›Šç‡',
                        data: portfolio.map(p => p.returnPct),
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: {
                                callback: value => value.toFixed(0) + '%'
                            }
                        }
                    }
                }
            });
            
            // èµ„äº§è¡¨ç°è¡¨æ ¼
            const assetNames = {
                nasdaq100: 'çº³æ–¯è¾¾å…‹100',
                sp500: 'æ ‡æ™®500',
                csi930955: 'ä¸­è¯çº¢åˆ©ä½æ³¢100',
                csi980092: 'è‡ªç”±ç°é‡‘æµæŒ‡æ•°',
                cnb00003: 'è¯é‡‘å€ºæŒ‡æ•°'
            };
            
            let assetHTML = '';
            const lastPortfolio = portfolio[portfolio.length - 1];
            
            for (let key in config.weights) {
                if (config.weights[key] > 0) {
                    const currentValue = lastPortfolio.assetValues[key];
                    const currentWeight = currentValue / lastPortfolio.totalValue * 100;
                    const targetWeight = config.weights[key] * 100;
                    
                    const initialPrice = filteredData[key][0].Close;
                    const finalPrice = filteredData[key][filteredData[key].length - 1].Close;
                    const priceReturn = (finalPrice / initialPrice - 1) * 100;
                    
                    const initialValue = shares[key] * initialPrice;
                    const profit = currentValue - initialValue;
                    
                    assetHTML += `
                        <tr>
                            <td><strong>${assetNames[key]}</strong></td>
                            <td>${targetWeight.toFixed(1)}%</td>
                            <td>${currentWeight.toFixed(2)}%</td>
                            <td>Â¥${(currentValue/10000).toFixed(1)}ä¸‡</td>
                            <td>Â¥${(profit/10000).toFixed(1)}ä¸‡</td>
                            <td>${priceReturn.toFixed(2)}%</td>
                        </tr>
                    `;
                }
            }
            document.getElementById('assetTableBody').innerHTML = assetHTML;
            
            // å†å¹³è¡¡ä¿¡æ¯
            if (rebalanceLog.length > 0) {
                let rebalanceHTML = '<h3 style="margin: 30px 0 20px 0; color: #667eea;">ğŸ”„ å†å¹³è¡¡è®°å½•</h3>';
                rebalanceHTML += '<div class="info-box">';
                rebalanceHTML += `<p><strong>å†å¹³è¡¡æ¬¡æ•°: ${rebalanceLog.length}æ¬¡</strong></p><ul style="margin-top: 10px;">`;
                rebalanceLog.forEach(log => {
                    rebalanceHTML += `<li>${log.date}: ${log.reasons}</li>`;
                });
                rebalanceHTML += '</ul></div>';
                document.getElementById('rebalanceInfo').innerHTML = rebalanceHTML;
            } else {
                document.getElementById('rebalanceInfo').innerHTML = '<div class="info-box">æœªè§¦å‘å†å¹³è¡¡</div>';
            }
        }
        
        // åˆå§‹åŒ–
        updateTotal();
        toggleRebalanceOptions();
        updateHistoryBadge();
    </script>
</body>
</html>

